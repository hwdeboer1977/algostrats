# Keeper Backend

This backend service automates flows after deposits into an **ERC-4626 vault** on Arbitrum.  
It listens for `Deposit` and `RequestWithdraw` events, then runs a **pipeline** to swap, bridge, deposit, and open/close positions on **Drift** and **Hyperliquid**.

A second **withdraw pipeline** orchestrates the reverse flow.

---

```mermaid
flowchart TD
  subgraph Vault
    V[ERC-4626 Vault]
  end

  %% --- User actions ---
  U[User via Frontend] -->|Deposit| V
  U -->|RequestWithdraw| V

  %% --- One poller listens to BOTH events ---
  V -->|Deposit event| EP[eventPoller]
  V -->|RequestWithdraw event| EP

  %% --- eventPoller routes work ---
  EP -->|Deposit job| DPipe[depositPipeline]
  EP -->|Withdraw request| WC[withdrawChecker]

  %% --- Deposit pipeline fan-out ---
  DPipe --> SB[Swap and Bridge]
  SB --> H[Hyperliquid]
  SB --> D[Drift]
  H --> HP[HL process: open and monitor]
  D --> DP[Drift process: open and monitor]

  %% --- Withdrawal path (checker â†’ pipeline) ---
  WC -->|stage calls| WP[withdrawPipeline]
  WP --> HLW[HL: close and withdraw]
  WP --> DRW[Drift: request then finalize]
  WP --> BR[Bridge back to Arbitrum]
  WP --> VAULT_SEND[Send USDC to vault]
  WP --> SWAP2[Swap USDC to WBTC]
  SWAP2 --> V
  V -->|payout| U

  %% --- Styling ---
  style U fill:#f9f,stroke:#333,stroke-width:1px
  style V fill:#bbf,stroke:#333,stroke-width:1px
  style EP fill:#ffd,stroke:#333,stroke-width:1px
  style DPipe fill:#efe,stroke:#333,stroke-width:1px
  style WC fill:#efe,stroke:#333,stroke-width:1px
  style WP fill:#efe,stroke:#333,stroke-width:1px
```

<sub>Note: Mermaid can be picky with Unicode arrows and parentheses in node labels. This version uses ASCII-only labels.</sub>

---

## ðŸ”„ Poller changes

- **eventPoller.js** _(replaces `depositPoller.js`)_  
  Unified on-chain listener that subscribes to vault events and enqueues jobs:
  - **`Deposit`** â†’ enqueues a **deposit job** handled by the **deposit pipeline** (swap â†’ bridge â†’ HL/Drift).
  - **`RequestWithdraw`** â†’ records a withdrawal request for the **withdraw checker** to time and advance.
  - (Optional) **`FinalizeWithdraw` / `Withdraw`** â†’ marks requests complete and clears local state.

Why? â†’ One poller = fewer race conditions and one source of truth for job queue + deduping.

---

## ðŸ§µ Withdrawal system (new)

The withdrawal flow is now composed of three moving parts:

1. **withdrawPipeline.js** â€” _stage orchestrator_  
   Reverses deposit allocation, step by step:

   - `--stage=close-hl` Close HL positions, free USDC.
   - `--stage=drift-request` Request Drift withdrawal.
   - `--stage=drift-finalize` Finalize Drift withdrawal after cooldown.
   - `--stage=withdraw-hl` Withdraw free USDC from HL.
   - `--stage=bridge-solana` Bridge Solana to Arbitrum USDC.
   - `--stage=send-to-vault` Send USDC back to the vault.
   - `--stage=swap-wbtc` Swap USDC to WBTC, complete payout.

   Each stage logs a **reqId** and writes progress to `withdraw_state.json`.

2. **withdrawChecker.js** â€” _timer/logic brain_

   - Watches pending withdrawal requests from `eventPoller`.
   - Tracks cooldowns (`cooldownTime`).
   - Updates `withdraw_state.json` so requests resume safely.
   - Calls `withdrawPipeline.js` with the correct stage when eligible.

3. **withdrawRunner.js** â€” _process supervisor_
   - Runs the **checker** in production, restarts on crash.
   - Surfaces logs to console/files.
   - Keeps a backlog so no request is lost if RPC hiccups.

Local state:

- **`withdraw_state.json`** â†’ `{ reqId â†’ { status, nextStage, lastSeen, ... } }`

---

## ðŸ§© Components

- **index.js** â€” Entry; bootstraps provider, ABIs, logger, queues; starts `eventPoller`.
- **eventPoller.js** â€” Replaces `depositPoller.js`. Subscribes to vault events (`Deposit`, `RequestWithdraw`, â€¦) and routes jobs.
- **depositPipeline.js** â€” Swap â†’ Bridge â†’ HL/Drift allocation after deposits.
- **withdrawPipeline.js** â€” Stage-based reverse flow for withdrawals.
- **withdrawChecker.js** â€” Schedules and advances withdrawal requests through pipeline stages.
- **withdrawRunner.js** â€” Keeps the checker alive (production supervisor).
- **rebalance.js** â€” `checkAndMaybeRebalance()` helper.
- **python_runner.js** â€” Runs HL Python utilities with JSON I/O.
- **send_usdc.js** â€” Arbitrum USDC transfer helper.
- **logger.js** â€” Console + daily rotate.

---

## ðŸ§ª How to run

**Keeper (deposits + monitoring):**

```bash
node index.js
```

**Withdrawal supervisor (checker + pipeline):**

```bash
node withdrawRunner.js
```

**Manual debug of one stage:**

```bash
node withdrawPipeline.js --stage=drift-finalize --reqId=req_1234567890
```

> In production: run `server.js`, `index.js`, and `withdrawRunner.js` as separate long-running processes (e.g. with pm2 or systemd).

---
